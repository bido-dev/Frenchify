# Frenchify Project Rules

## Project Overview
Frenchify is a language learning platform for teaching French, with separate student and teacher workflows.

## Technology Stack
- **Frontend**: React 18 + TypeScript + Vite
- **Styling**: Tailwind CSS v4 (CSS-based config in `src/index.css`)
- **Routing**: React Router DOM v6
- **Icons**: Lucide React
- **Backend**: Firebase Functions (Node.js + TypeScript)

## Code Organization

### Directory Structure
```
frontend/
├── src/
│   ├── components/    # Reusable UI components
│   ├── pages/         # Student route components
│   ├── teacherPages/  # Teacher route components
│   ├── adminPages/    # Admin route components
│   ├── forms/         # Form components (Login, Register, etc.)
│   ├── types/         # TypeScript interfaces
│   ├── utils/         # Helper functions
│   ├── App.tsx        # Main app with routing
│   └── index.css      # Tailwind v4 config + global styles
```

### Admin Pages Implementation

#### Admin Pages (`src/adminPages/`)
- **AdminLayout.tsx** - Main admin layout with sidebar navigation
  - Responsive sidebar with mobile overlay
  - Navigation items: Teacher Approvals, User Management, Subscriptions, Create Admin
  - User profile section with logout functionality
  - Uses `<Outlet />` for nested routes
  
- **TeacherApprovals.tsx** - Approve/reject teacher registrations
  - Displays pending teachers in a DataTable
  - Actions: Approve (green), Reject (red) with confirmation modal
  - Mock data with simulated API calls
  - Uses `PendingTeacher` type from `types/admin.ts`
  
- **UserManagement.tsx** - Manage all users
  - Search functionality with SearchBar component
  - Display users with role badges (student/teacher/admin)
  - Tier management: Toggle between free/paid subscriptions
  - Delete user functionality with confirmation modal
  - Admin users cannot be modified or deleted
  - Uses `AdminUser` type from `types/admin.ts`
  
- **CreateAdmin.tsx** - Create new admin accounts
  - Form validation (password match, min 8 characters)
  - Security notice alert
  - Success/error state handling
  - Mock API integration ready

#### Shared Components for Admin

- **DataTable.tsx** - Generic table component
  - Type-safe with TypeScript generics `<T>`
  - Column configuration with custom render functions
  - Loading state with spinner
  - Empty state with custom message
  - Hover effects on rows
  - Responsive with horizontal scroll
  
- **Modal.tsx** - Reusable modal dialog
  - Variants: danger, warning, info, default
  - Backdrop blur with click-to-close
  - ESC key to close
  - Custom footer support
  - Prevents body scroll when open
  
- **ActionButton.tsx** - Styled action buttons
  - Variants: approve, reject, delete, neutral, primary
  - Sizes: sm, md
  - Loading state with spinner
  - Icon support
  - Disabled state handling
  
- **Badge.tsx** - Status/role badges
  - Variants: free, pro, neutral, success, warning, danger, info
  - Used for roles (student/teacher/admin) and tiers (free/paid)
  - Uppercase text with bold styling
  
- **SearchBar.tsx** - Debounced search input
  - 300ms debounce delay
  - Clear button when text present
  - Magnifying glass icon
  - Controlled component pattern

#### Admin Types (`src/types/admin.ts`)

```typescript
interface PendingTeacher {
  uid: string;
  email: string;
  name?: string;
  createdAt: string;
  status: 'pending';
}

interface AdminUser {
  uid: string;
  email: string;
  name?: string;
  role: 'student' | 'teacher' | 'admin';
  tier: 'free' | 'paid';
  status: 'active' | 'pending' | 'rejected';
  createdAt: string;
}

interface SubscriptionUpdate {
  uid: string;
  tier: 'free' | 'paid';
}

interface TeacherApprovalAction {
  uid: string;
  action: 'approve' | 'reject';
}
```

#### Admin Authentication Flow

1. **Login** - User selects "Admin" role from Login.tsx
2. **Role Storage** - `localStorage.setItem('userRole', 'admin')`
3. **Route Protection** - `PrivateRoute` checks `requiredRole="admin"`
4. **Redirect** - Admin users navigate to `/admin` (redirects to `/admin/approvals`)
5. **Layout** - All admin pages wrapped in `AdminLayout` with sidebar

#### Admin Features Summary

- ✅ Teacher approval workflow (approve/reject with modals)
- ✅ User management (search, view, delete, subscription toggle)
- ✅ Admin account creation with validation
- ✅ Responsive design (mobile sidebar, desktop layout)
- ✅ Type-safe components with TypeScript
- ✅ Mock data ready for backend integration
- ✅ Reusable component library (DataTable, Modal, ActionButton, Badge)
- ✅ Loading and empty states
- ✅ Error handling and validation

## Component Guidelines

### Naming Conventions
- Components: PascalCase (e.g., `CourseCard.tsx`)
- Files: Match component name
- Props interfaces: `ComponentNameProps`
- Hooks: camelCase starting with `use` (e.g., `useAuth`)

### Component Structure
```tsx
import { ComponentProps } from '../types';

export default function ComponentName({ prop1, prop2 }: ComponentProps) {
  // 1. Hooks
  // 2. State
  // 3. Effects
  // 4. Handlers
  // 5. Render
  return (
    <div>
      {/* JSX */}
    </div>
  );
}
```

### Props Pattern
- Always destructure props in function signature
- Use TypeScript interfaces for prop types
- Provide default values when appropriate
- Example: `function Button({ label, variant = 'primary', onClick }: ButtonProps)`

## Styling Guidelines

### Tailwind CSS v4
- Configuration is in `src/index.css` using CSS variables
- Use `@theme` directive for custom tokens
- Utility-first approach - avoid inline styles

### Color Palette
```css
--color-primary: #2563eb;      /* Azure Blue */
--color-accent: #f59e0b;       /* Gold */
--color-success: #10b981;      /* Green */
--color-danger: #ef4444;       /* Red */
```

### Responsive Design
- Mobile-first approach
- Breakpoints: `sm:640px`, `md:768px`, `lg:1024px`, `xl:1280px`
- Test all layouts at 375px (mobile) and 1440px (desktop)

### Common Patterns
- Cards: `bg-white rounded-xl shadow-md p-6`
- Buttons: `px-6 py-3 rounded-lg font-medium transition-colors`
- Inputs: `w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary`
- Gradients: Use CSS gradients instead of images

## State Management

### Local State
- Use `useState` for component-local state
- Use `useReducer` for complex state logic
- Keep state as close to where it's used as possible

### Context
- Auth context: User authentication state
- Theme context (if needed): Dark/light mode
- Avoid prop drilling with context

## Firebase Integration

### Authentication
- Firebase Auth for user management
- Store user data in Firestore `users` collection
- Custom claims for role-based access (student, teacher, admin)

### Firestore Structure
```
users/{uid}
  - role: "student" | "teacher" | "admin"
  - tier: "free" | "paid"
  - status: "active" | "pending" | "rejected"

courses/{courseId}
  - teacherId, title, description, category, isPaid, status
  - materials/{materialId}
    - title, type, url, isFreePreview, order
  - questions/{questionId}
    - userId, content, isAnswered, answerText
```

### Security
- Never expose Firebase config in public repos
- Use environment variables for sensitive data
- Implement Firestore security rules
- Validate all user input

## Layout Components

### Navbar
- Fixed position with backdrop blur
- Different nav items for student/teacher/admin roles
- Responsive hamburger menu on mobile
- Ensure sufficient padding/margins (`pb-118`) to prevent overflow clipping

## Routing

### Route Structure
- Public: `/`, `/login`, `/register`
- Student (Protected): `/dashboard`, `/course/:id`, `/profile`
- Teacher (Protected): `/teacher/dashboard`, `/teacher/course/:id/edit`, `/teacher/questions`
- Admin (Protected): `/admin` (redirects to `/admin/approvals`), `/admin/users`, `/admin/create-admin`

### Navigation
- Use `useNavigate()` hook, NOT `window.location.href`
- Wrap protected routes with `<PrivateRoute>` component
- Use `<Link>` for internal navigation
- Active route detection: Use `location.pathname` with `startsWith()` for nested routes

## Performance

### Code Splitting
- All route components are lazy-loaded with React.lazy()
- Wrap routes in `<Suspense>` with loading fallback
- Expected initial bundle reduction: 30-40%

### Image Optimization
- Use CSS gradients instead of external images where possible
- Add `loading="lazy"` attribute to images
- Specify width/height to prevent layout shift

## Error Handling
- Entire app wrapped in `<ErrorBoundary>`
- Show user-friendly error messages
- Add loading states for async operations
- Show `<EmptyState>` when no data available

## Mock Data
- Use MOCK_COURSES for dashboard/teacher data
- Include category field: 'grammar' | 'conversation'
- Simulate API calls with setTimeout (800-1000ms)

## Testing Guidelines
- Test all pages at mobile breakpoints (375px)
- Verify authentication flow (login → redirect)
- Test filter functionality (All, Grammar, Conversation)
- Check loading states appear correctly
- Verify error boundaries catch errors

## Backend Architecture (Firebase Functions)

### Directory Structure
```
functions/src/
├── models/         # Database operations (pure functions, no HTTP logic)
│   ├── user.model.ts
│   ├── course.model.ts
│   ├── admin.model.ts
│   └── question.model.ts
├── controllers/    # HTTP request handlers (use models for DB operations)
│   ├── user.controller.ts
│   ├── course.controller.ts
│   ├── admin.controller.ts
│   ├── student.controller.ts
│   └── question.controller.ts
├── routes/         # Express route definitions with middleware
│   ├── user.routes.ts
│   ├── course.routes.ts
│   ├── admin.routes.ts
│   ├── student.routes.ts
│   └── question.routes.ts
├── middleware/     # Authentication and authorization
│   ├── auth.ts
│   └── roleCheck.ts
├── config/
│   └── firebase.ts
├── types/
│   └── express.d.ts
└── index.ts        # Main Express app
```

### MVC Pattern Rules
1. **Models** - Pure database operations only
   - Export functions that interact with Firestore/Auth
   - No HTTP logic (no `req`, `res` parameters)
   - Return data or throw errors
   - Example: `getUserById(uid: string): Promise<UserData | null>`

2. **Controllers** - HTTP request/response handling
   - Import and use model functions
   - Handle request validation
   - Send HTTP responses with appropriate status codes
   - Catch errors and return user-friendly messages
   - Example: `getProfile(req: Request, res: Response)`

3. **Routes** - Endpoint definitions with middleware
   - Define HTTP methods and paths
   - Apply middleware guards (isAuthenticated, isAdmin, etc.)
   - Import and use controller functions
   - Example: `router.get('/me', isAuthenticated, getProfile)`

### API Endpoints

#### User Routes (`/users`)
- `POST /users/sync` - Sync user after Firebase Auth signup (public)
- `GET /users/me` - Get authenticated user profile (requires: isAuthenticated)

#### Student Routes (`/students`)
- `GET /students/courses` - Browse published course catalog (public, supports `?category=grammar|conversation`)
- `GET /students/courses/:id` - Get single course details (public)
- `GET /students/courses/:id/materials` - Get materials with tier enforcement (requires: isAuthenticated)
  - Free tier: Only materials where `isFreePreview = true`
  - Paid tier: All materials

#### Course Routes (`/courses`) - All require: isAuthenticated + isTeacher
- `POST /courses` - Create course (draft mode)
- `PATCH /courses/:courseId` - Update course metadata
- `DELETE /courses/:courseId` - Delete course
- `POST /courses/:courseId/materials` - Add material (YouTube/video/quiz/PDF)
- `PATCH /courses/:courseId/materials/:materialId` - Update material
- `DELETE /courses/:courseId/materials/:materialId` - Delete material
- `PATCH /courses/:courseId/publish` - Publish course (checks teacher approval status)

#### Question Routes (`/questions`)
- `POST /questions/:courseId` - Student asks question (requires: isAuthenticated + isPaidTier)
- `GET /questions/:courseId` - Get all questions for a course (public)
- `PATCH /questions/:courseId/:questionId/answer` - Teacher answers question (requires: isAuthenticated + isTeacher)
- `GET /questions/teacher/unanswered` - Get unanswered questions for teacher's courses (requires: isAuthenticated + isTeacher)

#### Admin Routes (`/admin`) - All require: isAuthenticated + isAdmin
- `POST /admin/approve-teacher` - Approve/reject teacher registration
- `POST /admin/manage-subscription` - Manual tier override (free/paid)
- `DELETE /admin/users/:uid` - Delete user from Auth + Firestore
- `POST /admin/create-admin` - Create another admin account

### Middleware Guards
- `isAuthenticated` - Verifies Firebase ID token, attaches `req.user`
- `isAdmin` - Checks if user role is "admin"
- `isTeacher` - Checks if user role is "teacher" AND status is "active"
- `isPaidTier` - Checks if user tier is "paid"

### Data Models

#### UserData (Firestore: `users/{uid}`)
```typescript
{
  uid: string;
  email: string;
  role: "student" | "teacher" | "admin";
  tier: "free" | "paid";
  status: "active" | "pending" | "rejected";
  createdAt: string;
}
```

#### CourseData (Firestore: `courses/{courseId}`)
```typescript
{
  teacherId: string;
  title: string;
  description: string;
  category: "grammar" | "conversation";
  isPaid: boolean;
  status: "draft" | "published";
  createdAt: string;
  updatedAt: string;
}
```

#### MaterialData (Firestore: `courses/{courseId}/materials/{materialId}`)
```typescript
{
  title: string;
  type: "video" | "youtube" | "quiz" | "pdf";
  url: string;
  isFreePreview: boolean;
  order: number;
}
```

#### QuestionData (Firestore: `courses/{courseId}/questions/{questionId}`)
```typescript
{
  courseId: string;
  userId: string;
  userName: string;
  content: string;
  createdAt: string;
  isAnswered: boolean;
  answerText?: string;
  answeredAt?: string;
}
```

### Testing
- **Framework**: Jest + ts-jest + supertest
- **Config**: `jest.config.js` in functions directory
- **Commands**:
  - `npm test` - Run all tests
  - `npm run test:watch` - Watch mode
  - `npm run test:coverage` - Coverage report
- **Mock Firestore** for unit tests using `jest.mock()`

### Build & Deploy
- `npm run build` - TypeScript compilation (must pass before deploy)
- `npm run deploy` - Deploy to Firebase Cloud Functions
- Entry point: `functions/lib/index.js` (compiled from src/index.ts)

## Do NOT
- ❌ Use `window.location.href` for navigation
- ❌ Import React in every file (not needed in React 18)
- ❌ Use inline styles instead of Tailwind classes
- ❌ Hardcode colors - use Tailwind utilities
- ❌ Skip error boundaries for new features
- ❌ Forget default exports for lazy-loaded components
- ❌ Use external image CDNs (e.g., pravatar.cc) - use local/gradient
- ❌ Make direct database calls in controllers - always use model layer

## Key Files Reference
- Component library: `src/components/`
- Route components: `src/pages/`, `src/forms/`, `src/teacherPages/`, `src/adminPages/`
- Type definitions: `src/types/course.ts`, `src/types/user.ts`, `src/types/admin.ts`
- Styling config: `src/index.css` (Tailwind v4)
- Main app: `src/App.tsx` (with lazy loading + ErrorBoundary)
