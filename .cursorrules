# Frenchify Project Rules

## Project Overview
Frenchify is a language learning platform for teaching French, with separate student and teacher workflows.

## Technology Stack
- **Frontend**: React 18 + TypeScript + Vite
- **Styling**: Tailwind CSS v4 (CSS-based config in `src/index.css`)
- **Routing**: React Router DOM v6
- **Icons**: Lucide React
- **Backend**: Firebase Functions (Node.js + TypeScript)

## Code Organization

### Directory Structure
```
frontend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ api/            # API layer (axios + Firebase integration)
‚îÇ   ‚îú‚îÄ‚îÄ components/     # Reusable UI components
‚îÇ   ‚îú‚îÄ‚îÄ config/         # Configuration files (Firebase, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ contexts/       # React contexts (Auth, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ hooks/          # Custom React hooks
‚îÇ   ‚îú‚îÄ‚îÄ pages/          # Student route components
‚îÇ   ‚îú‚îÄ‚îÄ teacherPages/   # Teacher route components
‚îÇ   ‚îú‚îÄ‚îÄ adminPages/     # Admin route components
‚îÇ   ‚îú‚îÄ‚îÄ forms/          # Form components (Login, Register, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ types/          # TypeScript interfaces
‚îÇ   ‚îú‚îÄ‚îÄ utils/          # Helper functions
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx         # Main app with routing
‚îÇ   ‚îî‚îÄ‚îÄ index.css       # Tailwind v4 config + global styles
```

### Custom Hooks (`src/hooks/`)

- **usePendingTeachers.ts** - Real-time Firestore listener for pending teachers
  - Queries `users` collection where `role='teacher'` AND `status='pending'`
  - Uses `onSnapshot` for WebSocket-based real-time updates
  - Automatically updates when teachers register or reapply
  - Returns: `{ teachers, loading, error }`
  - Auto-cleanup on unmount
  - Used by admin TeacherApprovals page

- **useUserStatus.ts** - Real-time listener for individual user's status
  - Listens to user document in Firestore
  - Detects status changes (pending ‚Üí active)
  - Returns: `{ status, loading }`
  - Used by pending approval page for auto-redirect
  - Auto-cleanup on unmount

### Admin Pages Implementation

#### Admin Pages (`src/adminPages/`)
- **AdminLayout.tsx** - Main admin layout with sidebar navigation
  - Responsive sidebar with mobile overlay
  - Navigation items: Teacher Approvals, User Management, Subscriptions, Create Admin
  - User profile section with logout functionality
  - Uses `<Outlet />` for nested routes
  
- **TeacherApprovals.tsx** - Approve/reject teacher registrations with real-time updates
  - **Real-time Updates**: Uses `usePendingTeachers` hook with Firestore listeners
  - Automatically shows new pending teachers when they register or reapply
  - No polling - uses WebSocket connection for instant updates
  - Actions: Approve (green), Reject (red) with confirmation modal
  - Toast notifications for success/error feedback
  - Loading and empty states with friendly messages
  - Uses `PendingTeacher` type from `types/admin.ts`
  
- **UserManagement.tsx** - Manage all users
  - Search functionality with SearchBar component
  - Display users with role badges (student/teacher/admin)
  - Tier management: Toggle between free/paid subscriptions
  - Delete user functionality with confirmation modal
  - Admin users cannot be modified or deleted
  - Uses `AdminUser` type from `types/admin.ts`
  
- **CreateAdmin.tsx** - Create new admin accounts
  - Form validation (password match, min 8 characters)
  - Security notice alert
  - Success/error state handling
  - Real API integration

#### Shared Components for Admin

- **DataTable.tsx** - Generic table component
  - Type-safe with TypeScript generics `<T>`
  - Column configuration with custom render functions
  - Loading state with spinner
  - Empty state with custom message
  - Hover effects on rows
  - Responsive with horizontal scroll
  
- **Modal.tsx** - Reusable modal dialog
  - Variants: danger, warning, info, default
  - Backdrop blur with click-to-close
  - ESC key to close
  - Custom footer support
  - Prevents body scroll when open
  
- **ActionButton.tsx** - Styled action buttons
  - Variants: approve, reject, delete, neutral, primary
  - Sizes: sm, md
  - Loading state with spinner
  - Icon support
  - Disabled state handling
  
- **Badge.tsx** - Status/role badges
  - Variants: free, pro, neutral, success, warning, danger, info
  - Used for roles (student/teacher/admin) and tiers (free/paid)
  - Uppercase text with bold styling
  
- **SearchBar.tsx** - Debounced search input
  - 300ms debounce delay
  - Clear button when text present
  - Magnifying glass icon
  - Controlled component pattern

- **Toast.tsx** - Notification component for user feedback
  - Variants: success, error, info
  - Auto-dismissal with configurable duration (default 3s)
  - Manual close button
  - Icons and colors for each variant
  - Fixed position at top-right
  - Used for API success/error messages

#### Admin Types (`src/types/admin.ts`)

```typescript
interface PendingTeacher {
  uid: string;
  email: string;
  name?: string;
  createdAt: string;
  status: 'pending';
}

interface AdminUser {
  uid: string;
  email: string;
  name?: string;
  role: 'student' | 'teacher' | 'admin';
  tier: 'free' | 'paid';
  status: 'active' | 'pending' | 'rejected';
  createdAt: string;
}

interface SubscriptionUpdate {
  uid: string;
  tier: 'free' | 'paid';
}

interface TeacherApprovalAction {
  uid: string;
  action: 'approve' | 'reject';
}
```

#### Admin Authentication Flow

1. **Login** - User selects "Admin" role from Login.tsx
2. **Role Storage** - `localStorage.setItem('userRole', 'admin')`
3. **Route Protection** - `PrivateRoute` checks `requiredRole="admin"`
4. **Redirect** - Admin users navigate to `/admin` (redirects to `/admin/approvals`)
5. **Layout** - All admin pages wrapped in `AdminLayout` with sidebar

#### Admin Features Summary

- ‚úÖ Teacher approval workflow (approve/reject with modals)
- ‚úÖ User management (search, view, delete, subscription toggle)
- ‚úÖ **Admin delete user/teacher with cascade deletion** (removes courses, enrollments, questions)
- ‚úÖ Admin account creation with validation
- ‚úÖ Responsive design (mobile sidebar, desktop layout)
- ‚úÖ Type-safe components with TypeScript
- ‚úÖ Real API integration (no mock data)
- ‚úÖ Reusable component library (DataTable, Modal, ActionButton, Badge, Toast)
- ‚úÖ Loading and empty states
- ‚úÖ Error handling and validation
- ‚úÖ Toast notifications for user feedback

#### Teacher Approval Workflow

**Complete Flow**: Registration ‚Üí Pending ‚Üí Approval/Rejection ‚Üí Access Control

**1. Teacher Registration**
- Teacher registers via `/register` with role "teacher"
- Firebase Auth account created
- Backend syncs to Firestore with `status: "pending"`
- Teacher redirected to login

**2. Pending State**
- Teacher logs in ‚Üí Auto-redirected to `/teacher/pending` by `PrivateRoute`
- `PendingApproval.tsx` component shows:
  - Friendly waiting message with yellow theme
  - Status badge: "Pending"
  - Cannot access teacher dashboard or features
  - Real-time status monitoring via `useUserStatus` hook

**3. Admin Approval Process**
- Admin views pending teachers in `TeacherApprovals.tsx`
- Real-time list via `usePendingTeachers` Firestore listener
- Admin clicks "Approve" or "Reject"
- Backend updates teacher's status in Firestore
- Toast notification confirms action

**4. Auto-Redirect on Approval**
- When admin approves, Firestore updates status to "active"
- `useUserStatus` hook detects change via real-time listener
- Success toast appears: "Your account has been approved! Redirecting..."
- After 1.5 seconds, auto-navigates to `/teacher/dashboard`
- Teacher now has full access to all teacher features

**5. Rejection and Reapplication**
- Rejected teachers see red-themed page with rejection message
- "Reapply for Teacher Account" button appears
- Clicking reapply calls `POST /users/reapply`
- Status changes from "rejected" ‚Üí "pending"
- UI updates to yellow pending theme
- Teacher appears in admin's pending list instantly (real-time)

**Access Control**:
- **Backend**: `isTeacher` middleware checks `status === "active"`
- **Frontend**: `PrivateRoute` redirects pending/rejected teachers
- Teachers cannot bypass by URL manipulation (enforced on both ends)

**Real-Time Features**:
- Admin sees new registrations/reapplications without page refresh
- Teacher sees approval and redirects automatically
- Uses Firestore WebSocket listeners (no polling)
- Efficient: Single connection per user

### Teacher Pages Implementation

#### Teacher Pages (`src/teacherPages/`)

- **TeacherDashboard.tsx** - Overview hub
  - **Stats Cards**: Total courses, active students, pending questions
  - **Courses List**: Display courses with status (Draft/Published) and enrollment counts
  - **Quick Actions**: "Create Course" button
  - **Delete Functionality**: Remove courses with confirmation modal

- **CourseEditor.tsx** - Comprehensive course management
  - **Modes**: Create New / Edit Existing
  - **Metadata Editing**: Title, description, category (Grammar/Conversation), paid status
  - **Materials Management**: 
    - Add/Edit/Delete materials (Video, YouTube, Quiz, PDF)
    - Reorder materials (UI implementation pending)
    - Toggle "Free Preview" status
  - **Publishing Flow**: Draft -> Published (requires active teacher status)
  - **Validation**: Prevents publishing without saving or if teacher is not active

- **MyQuestions.tsx** - Q&A Management
  - Fetches unanswered questions from student enrollments
  - UI for typing and sending replies
  - Updates local state optimistically upon answering

- **PendingApproval.tsx** - Gatekeeper page
  - Shown to teachers with `status: "pending"` or `status: "rejected"`
  - Real-time status listening to auto-redirect upon approval

### API Organization & Authentication

#### API Layer (`src/api/`)

The frontend uses a centralized API layer with axios for all HTTP requests:

- **index.ts** - Central axios instance
  - Base URL from `VITE_API_URL` environment variable
  - Request interceptor: Automatically attaches Firebase ID token to all authenticated requests
  - Response interceptor: Handles 401 errors and redirects to login
  - 10-second timeout for all requests
  
- **auth.api.ts** - Authentication endpoints
  - `signup(data)` - Register with email/password and role (student/teacher)
  - `login(email, password)` - Sign in with email/password
  - `loginWithGoogle()` - Google OAuth sign-in
  - `logout()` - Sign out and clear localStorage
  - `getCurrentUser()` - Fetch user profile from backend
  - Returns `UserData` interface with role, tier, and status
  
- **student.api.ts** - Student features
  - `getCourses(category?)` - Browse course catalog with optional filter
  - `getCourse(courseId)` - Get single course details
  - `getCourseMaterials(courseId)` - Get materials (tier-enforced by backend)
  - `askQuestion(courseId, content)` - Post question (paid tier only)
  - `getCourseQuestions(courseId)` - Get all Q&A for a course
  - `getMyQuestions()` - Get all questions asked by the logged-in student across all courses
  - `getStudentStats()` - Get student statistics (enrolled, completed, hours, streak)
  - `getEnrolledCourses()` - Get enrolled courses with progress
  - Returns `StudentStats` and `EnrolledCourse` interfaces
  
- **teacher.api.ts** - Teacher dashboard stats
  - `getTeacherStats()` - Get teaching statistics (courses created, total students, pending questions)
  - `getTeacherCourses()` - Get teacher's courses with enrollment counts
  - Returns `TeacherStats` and `TeacherCourse` interfaces

- **course.api.ts** - Course management (CRUD)
  - `createCourse(data)` - Create new draft course
  - `getCourse(id)` - Get course details
  - `updateCourse(id, data)` - Update metadata
  - `getCourseMaterials(id)` - Get all materials (teacher view)
  - `addMaterial`, `updateMaterial`, `deleteMaterial` - Manage content
  - `publishCourse(id)` - Make course live

- **question.api.ts** - Q&A management
  - `getUnansweredQuestions()` - Get pending student questions
  - `answerQuestion(courseId, questionId, text)` - Reply to student

  
- **admin.api.ts** - Admin features
  - `getAllUsers()` - Fetch all users (admin only)
  - `getPendingTeachers()` - Fetch pending teachers (for initial load, real-time uses Firestore)
  - `approveTeacher(data)` - Approve/reject teacher applications
  - `updateSubscription(data)` - Manage user subscription tiers
  - `deleteUser(uid)` - Remove user account
  - `createAdmin(email, password, name?)` - Create new admin account

#### Firebase Configuration (`src/config/`)

- **firebase.ts** - Firebase client initialization
  - Uses environment variables for credentials:
    - `VITE_FIREBASE_API_KEY`
    - `VITE_FIREBASE_AUTH_DOMAIN`
    - `VITE_FIREBASE_PROJECT_ID`
    - `VITE_FIREBASE_STORAGE_BUCKET`
    - `VITE_FIREBASE_MESSAGING_SENDER_ID`
    - `VITE_FIREBASE_APP_ID`
    - `VITE_USE_EMULATOR` - Set to 'true' for local development
  - Exports `auth` instance for authentication
  - Exports `db` (Firestore) instance for real-time data
  - Emulator configuration:
    - Auth Emulator: `localhost:9099`
    - Firestore Emulator: `localhost:8080`

#### Authentication Context (`src/contexts/`)

- **AuthContext.tsx** - Global authentication state
  - Listens to Firebase auth state via `onAuthStateChanged`
  - Fetches user data from backend when authenticated
  - Provides `useAuth()` hook for components
  - Context values:
    - `user` - UserData from backend (role, tier, status)
    - `firebaseUser` - Firebase User object
    - `loading` - Boolean for initial auth check
    - `refreshUser()` - Function to manually refresh user data

#### Authentication Flow

**Registration:**
1. User fills form and selects role (student/teacher)
2. Firebase creates auth account via `createUserWithEmailAndPassword()`
3. **Email Verification**: Frontend calls `sendEmailVerification()` and signs user out
4. Backend syncs user to Firestore via `POST /users/sync`
5. Students get `tier: "free"`, `status: "active"`
6. Teachers get `tier: "free"`, `status: "pending"` (awaiting admin approval)
7. User redirected to login page (must verify email before logging in)

**Login:**
1. User enters credentials
2. Firebase authenticates via `signInWithEmailAndPassword()`
3. **Verification Check**: Frontend checks `user.emailVerified`. If false, signs out and blocks login.
4. Frontend fetches user data via `GET /users/me` (with ID token)
4. AuthContext updates with user data
5. User redirected based on role:
   - Admin ‚Üí `/admin`
   - Teacher ‚Üí `/teacher/dashboard`
   - Student ‚Üí `/dashboard` (or preserved `from` location)

**Google Sign-In:**
1. User clicks "Continue with Google"
2. Firebase handles OAuth via `signInWithPopup()`
3. Backend syncs user with `role: "student"` by default
4. User redirected to dashboard

**Protected Routes:**
1. `PrivateRoute` component checks `useAuth()` context
2. If loading, shows spinner
3. If not authenticated, redirects to `/login` with `from` state
4. If wrong role, redirects to appropriate dashboard
5. If authorized, renders protected content

#### API Request Flow

All authenticated requests automatically include the Firebase ID token:

```typescript
// Request interceptor in api/index.ts
api.interceptors.request.use(async (config) => {
  const user = auth.currentUser;
  if (user) {
    const token = await user.getIdToken();
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});
```

Backend verifies the token and attaches user data to `req.user`.

#### Race Condition Prevention

**Problem**: Firebase Auth state updates asynchronously, causing `auth.currentUser` to be `null` immediately after login, which resulted in API calls without tokens.

**Solution** (implemented in `auth.api.ts` and `AuthContext.tsx`):

1. **Explicit Token Passing**: Get the token directly from `userCredential` returned by Firebase Auth instead of relying on `auth.currentUser`:
```typescript
const userCredential = await signInWithEmailAndPassword(auth, email, password);
const token = await userCredential.user.getIdToken();
const response = await api.get('/users/me', {
    headers: { Authorization: `Bearer ${token}` }
});
```

2. **AuthContext Retry Logic**: The context waits for token readiness and retries API calls:
```typescript
await firebaseUser.getIdToken(); // Ensures token is ready
let retries = 3;
while (retries > 0 && !userData) {
    try {
        userData = await getCurrentUser();
    } catch (error) {
        retries--;
        await new Promise(resolve => setTimeout(resolve, 200));
    }
}
```

3. **No Hard Redirects on 401**: The API interceptor should NOT use `window.location.href` for redirects as it breaks React state. Let `PrivateRoute` handle auth redirects via React Router.

4. **Backend Failure Handling**: AuthContext detects CORS/network errors after 3 retries and automatically signs out the user to prevent infinite loops. This ensures graceful degradation when the backend is unavailable.

#### Updated Components

**App.tsx:**
- Wrapped with `<AuthProvider>` to provide auth context to all routes
- All components now have access to `useAuth()` hook

**PrivateRoute.tsx:**
- Uses `useAuth()` instead of localStorage
- Shows loading spinner during auth check
- Redirects based on authentication state and role
- **Teacher Status Control**:
  - Pending teachers ‚Üí `/teacher/pending`
  - Rejected teachers ‚Üí `/teacher/pending` (with reapply option)
  - Active teachers ‚Üí Full access to teacher routes

**Login.tsx:**
- Real Firebase authentication (no more mock)
- Email/password login via `login()` API
- Google sign-in via `loginWithGoogle()` API
- Error handling with user-friendly messages
- Role-based redirect after successful login
- Removed role selector (role determined by backend)

**Register.tsx:**
- Real Firebase registration (no more mock)
- Role selector (Student/Teacher)
- Email/password registration via `signup()` API
- Password confirmation validation
- Minimum 8 characters password requirement
- Teacher approval notification
- Error handling with user-friendly messages
- Redirects to login after successful registration

#### Environment Variables

Create `.env` file in `frontend/` directory:

```bash
# Firebase Configuration
VITE_FIREBASE_API_KEY=your_api_key_here
VITE_FIREBASE_AUTH_DOMAIN=your_project_id.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=your_project_id
VITE_FIREBASE_STORAGE_BUCKET=your_project_id.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=your_sender_id
VITE_FIREBASE_APP_ID=your_app_id

# API Configuration
VITE_API_URL=http://localhost:5001/frenchify/us-central1/api
```

#### Type Definitions

**UserData** (from `api/auth.api.ts`):
```typescript
interface UserData {
  uid: string;
  email: string;
  name?: string;
  role: 'student' | 'teacher' | 'admin';
  tier: 'free' | 'paid';
  status: 'active' | 'pending' | 'rejected';
  createdAt: string;
}
```

**SignupData** (from `api/auth.api.ts`):
```typescript
interface SignupData {
  email: string;
  password: string;
  role: 'student' | 'teacher';
  name?: string;
}
```

## Component Guidelines

### Naming Conventions
- Components: PascalCase (e.g., `CourseCard.tsx`)
- Files: Match component name
- Props interfaces: `ComponentNameProps`
- Hooks: camelCase starting with `use` (e.g., `useAuth`)

### Component Structure
```tsx
import { ComponentProps } from '../types';

export default function ComponentName({ prop1, prop2 }: ComponentProps) {
  // 1. Hooks
  // 2. State
  // 3. Effects
  // 4. Handlers
  // 5. Render
  return (
    <div>
      {/* JSX */}
    </div>
  );
}
```

### Props Pattern
- Always destructure props in function signature
- Use TypeScript interfaces for prop types
- Provide default values when appropriate
- Example: `function Button({ label, variant = 'primary', onClick }: ButtonProps)`

## Styling Guidelines

### Tailwind CSS v4
- Configuration is in `src/index.css` using CSS variables
- Use `@theme` directive for custom tokens
- Utility-first approach - avoid inline styles

### Color Palette
```css
--color-primary: #2563eb;      /* Azure Blue */
--color-accent: #f59e0b;       /* Gold */
--color-success: #10b981;      /* Green */
--color-danger: #ef4444;       /* Red */
```

### Responsive Design
- Mobile-first approach
- Breakpoints: `sm:640px`, `md:768px`, `lg:1024px`, `xl:1280px`
- Test all layouts at 375px (mobile) and 1440px (desktop)

### Common Patterns
- Cards: `bg-white rounded-xl shadow-md p-6`
- Buttons: `px-6 py-3 rounded-lg font-medium transition-colors`
- Inputs: `w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary`
- Gradients: Use CSS gradients instead of images

## State Management

### Local State
- Use `useState` for component-local state
- Use `useReducer` for complex state logic
- Keep state as close to where it's used as possible

### Global Context
- **AuthContext** (`src/contexts/AuthContext.tsx`): User authentication state
  - Provides `useAuth()` hook
  - Values: `user`, `firebaseUser`, `loading`, `refreshUser()`
  - Automatically syncs with Firebase Auth
- Theme context (if needed): Dark/light mode
- Avoid prop drilling with context

## Firebase Integration

### Authentication
- Firebase Auth for user management
- Store user data in Firestore `users` collection
- Custom claims for role-based access (student, teacher, admin)

### Firestore Structure
```
users/{uid}
  - role: "student" | "teacher" | "admin"
  - tier: "free" | "paid"
  - status: "active" | "pending" | "rejected"

courses/{courseId}
  - teacherId, title, description, category, isPaid, status
  - materials/{materialId}
    - title, type, url, isFreePreview, order
    - materials/{materialId}
    - title, type, url, isFreePreview, order
  - questions/{questionId}
    - userId, content, isAnswered, answerText
  - lessons/{lessonId}
    - title, video, pdf
    - materials: [{ id, title, url, type }]  <-- Multiple materials support
```

### Security
- Never expose Firebase config in public repos
- Use environment variables for sensitive data
- Implement Firestore security rules
- Validate all user input

## Layout Components

### Unified Layout (`Layout.tsx`)
- Main container used for both **Student** and **Teacher** roles.
- Features a sticky top navbar (Frenchify logo, profile icon, clear view) and a **responsive sidebar** toggled by a hamburger menu.
- Sidebar dynamically renders navigation links based on user role (`useAuth()`):
  - **Student**: Catalog (`/dashboard`), My Questions (`/my-questions`), Profile (`/profile`).
  - **Teacher**: Courses (`/teacher/dashboard`), My Questions (`/teacher/questions`), Profile (`/profile`).

### Admin Layout (`AdminLayout.tsx`)
- Dedicated layout for administrative tasks with its own sidebar configuration.

## Routing

### Route Structure
- Public: `/`, `/login`, `/register`
- Student (Protected): `/dashboard`, `/course/:id`, `/my-questions`, `/profile`
- Teacher (Protected): `/teacher/dashboard`, `/teacher/course/:id/edit`, `/teacher/questions`
- Admin (Protected): `/admin` (redirects to `/admin/approvals`), `/admin/users`, `/admin/create-admin`

### Navigation
- Use `useNavigate()` hook, NOT `window.location.href`
- Wrap protected routes with `<PrivateRoute>` component
- Use `<Link>` for internal navigation
- Active route detection: Use `location.pathname` with `startsWith()` for nested routes

## Performance

### Code Splitting
- All route components are lazy-loaded with React.lazy()
- Wrap routes in `<Suspense>` with loading fallback
- Expected initial bundle reduction: 30-40%

### Image Optimization
- Use CSS gradients instead of external images where possible
- Add `loading="lazy"` attribute to images
- Specify width/height to prevent layout shift

## Error Handling
- Entire app wrapped in `<ErrorBoundary>`
- Show user-friendly error messages
- Add loading states for async operations
- Show `<EmptyState>` when no data available

## Mock Data
- Use MOCK_COURSES for dashboard/teacher data
- Include category field: 'grammar' | 'conversation'
- Simulate API calls with setTimeout (800-1000ms)

## Testing Guidelines
- Test all pages at mobile breakpoints (375px)
- Verify authentication flow (login ‚Üí redirect)
- Test filter functionality (All, Grammar, Conversation)
- Check loading states appear correctly
- Verify error boundaries catch errors

## Backend Architecture (Firebase Functions)

```
functions/src/
‚îú‚îÄ‚îÄ models/         # Database operations (pure functions, no HTTP logic)
‚îÇ   ‚îú‚îÄ‚îÄ admin.model.ts
‚îÇ   ‚îú‚îÄ‚îÄ course.model.ts
‚îÇ   ‚îú‚îÄ‚îÄ enrollment.model.ts  # Student course enrollments
‚îÇ   ‚îú‚îÄ‚îÄ lesson.model.ts      # Lesson CRUD operations
‚îÇ   ‚îú‚îÄ‚îÄ question.model.ts
‚îÇ   ‚îú‚îÄ‚îÄ student.model.ts     # Student statistics
‚îÇ   ‚îú‚îÄ‚îÄ teacher.model.ts     # Teacher statistics
‚îÇ   ‚îî‚îÄ‚îÄ user.model.ts
‚îú‚îÄ‚îÄ controllers/    # HTTP request handlers (use models for DB operations)
‚îÇ   ‚îú‚îÄ‚îÄ admin.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ course.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ lesson.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ question.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ student.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ teacher.controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ user.controller.ts
‚îú‚îÄ‚îÄ routes/         # Express route definitions with middleware
‚îÇ   ‚îú‚îÄ‚îÄ admin.routes.ts
‚îÇ   ‚îú‚îÄ‚îÄ course.routes.ts
‚îÇ   ‚îú‚îÄ‚îÄ lesson.routes.ts
‚îÇ   ‚îú‚îÄ‚îÄ question.routes.ts
‚îÇ   ‚îú‚îÄ‚îÄ student.routes.ts
‚îÇ   ‚îú‚îÄ‚îÄ teacher.routes.ts
‚îÇ   ‚îî‚îÄ‚îÄ user.routes.ts
‚îú‚îÄ‚îÄ middleware/     # Authentication and authorization
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts
‚îÇ   ‚îî‚îÄ‚îÄ roleCheck.ts
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ firebase.ts
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ express.d.ts
‚îú‚îÄ‚îÄ seed.ts                 # Emulator seed script (creates admin user)
‚îú‚îÄ‚îÄ seed-enrollments.ts     # Seed script for test data (students, teachers, courses, enrollments)
‚îî‚îÄ‚îÄ index.ts                # Main Express app
```

### Emulator Seed Script

**Purpose**: Creates a hardcoded admin user in Firebase Auth + Firestore for development/testing.

**File**: `functions/src/seed.ts`

**Admin Credentials**:
| Field | Value |
|-------|-------|
| Email | `admin@frenchify.com` |
| Password | `admin123456` |
| Name | `System Admin` |
| Role | `admin` |

**Usage**:
1. Start emulators: `firebase emulators:start`
2. In another terminal: `cd functions && npm run seed`

**Important**: 
- The script uses project ID from `.firebaserc` (currently `frechify`)
- Emulator data is **ephemeral** - run seed after each emulator restart
- The script is idempotent (safe to run multiple times)

### Test Data Seed Script

**Purpose**: Creates test users, courses, enrollments, and questions for testing profile stats.

**File**: `functions/src/seed-enrollments.ts`

**Test Accounts**:
| Email | Password | Role | Tier | Status |
|-------|----------|------|------|--------|
| `student@test.com` | `test1234` | student | paid | active |
| `teacher@test.com` | `test1234` | teacher | free | active |

**Sample Data Created**:
- 3 courses (2 published, 1 draft)
- 2 enrollments for student (1 in progress, 1 completed)
- 2 questions (1 pending, 1 answered)

**Usage**:
1. Start emulators and run admin seed first
2. Run: `cd functions && npm run seed:enrollments`

### MVC Pattern Rules
1. **Models** - Pure database operations only
   - Export functions that interact with Firestore/Auth
   - No HTTP logic (no `req`, `res` parameters)
   - Return data or throw errors
   - Example: `getUserById(uid: string): Promise<UserData | null>`

2. **Controllers** - HTTP request/response handling
   - Import and use model functions
   - Handle request validation
   - Send HTTP responses with appropriate status codes
   - Catch errors and return user-friendly messages
   - Example: `getProfile(req: Request, res: Response)`

3. **Routes** - Endpoint definitions with middleware
   - Define HTTP methods and paths
   - Apply middleware guards (isAuthenticated, isAdmin, etc.)
   - Import and use controller functions
   - Example: `router.get('/me', isAuthenticated, getProfile)`

### API Endpoints

#### User Routes (`/users`)
- `POST /users/sync` - Sync user after Firebase Auth signup (public)
- `GET /users/me` - Get authenticated user profile (requires: isAuthenticated)
- `POST /users/reapply` - Reapply for teacher account (rejected ‚Üí pending) (requires: isAuthenticated)

#### Student Routes (`/students`)
- `GET /students/courses` - Browse published course catalog (public, supports `?category=grammar|conversation`)
- `GET /students/courses/:id` - Get single course details (public)
- `GET /students/courses/:id/materials` - Get materials with tier enforcement (requires: isAuthenticated)
  - Free tier: Only materials where `isFreePreview = true`
  - Paid tier: All materials
- `GET /students/stats` - Get student statistics (requires: isAuthenticated)
- `GET /students/enrolled` - Get enrolled courses with progress (requires: isAuthenticated)

#### Course Routes (`/courses`) - All require: isAuthenticated + isTeacher
- `GET /courses/:courseId/materials` - Get all materials (course owner only, no tier filtering)
- `POST /courses` - Create course (draft mode)
- `PATCH /courses/:courseId` - Update course metadata
- `DELETE /courses/:courseId` - Delete course
- `POST /courses/:courseId/materials` - Add material to library (YouTube/video/quiz/PDF)
  - Storage path: `materials/{userId}/{timestamp}_{filename}`
- `POST /courses/:courseId/materials/generate-quiz` - **AI Quiz Generation** (requires: isAuthenticated + isTeacher)
  - Body: `{ title, numberOfQuestions, language, questionTypes, difficulty, isFreePreview, pdfUrls }`
  - Fetches PDFs from Firebase Storage URLs, extracts text with `pdf-parse`, calls Gemini API
  - Saves the generated quiz JSON (stringified) as a material with `type: 'quiz'`
- `PATCH /courses/:courseId/materials/:materialId` - Update material
- `DELETE /courses/:courseId/materials/:materialId` - Delete material
- `PATCH /courses/:courseId/publish` - Publish course (checks teacher approval status)

#### Lesson Routes (`/courses/:courseId/lessons`)
- `POST /` - Create lesson (links to existing materials via IDs, supports `materials` array)
- `GET /` - Get all lessons for a course (Public for students via `/students/courses/:id/lessons`)
- `PATCH /:lessonId` - Update lesson details (title, video, materials)
- `DELETE /:lessonId` - Delete lesson

#### Question Routes (`/questions`)
- `GET /questions/student/my` - Get all questions asked by the student across all courses (requires: isAuthenticated)
- `POST /questions/:courseId` - Student asks question (requires: isAuthenticated + isPaidTier)
- `GET /questions/:courseId` - Get all questions for a course (public)
- `PATCH /questions/:courseId/:questionId/answer` - Teacher answers question (requires: isAuthenticated + isTeacher)
- `GET /questions/teacher/unanswered` - Get unanswered questions for teacher's courses (requires: isAuthenticated + isTeacher)

#### Teacher Routes (`/teachers`) - All require: isAuthenticated + isTeacher
- `GET /teachers/stats` - Get teaching statistics (courses created, total students, pending questions)
- `GET /teachers/courses` - Get teacher's courses with enrollment counts

#### Admin Routes (`/admin`) - All require: isAuthenticated + isAdmin
- `GET /admin/users` - Get all users (admin only)
- `GET /admin/pending-teachers` - Get list of pending teacher applications
- `POST /admin/approve-teacher` - Approve/reject teacher registration
- `POST /admin/manage-subscription` - Manual tier override (free/paid)
- `DELETE /admin/users/:uid` - Delete user from Auth + Firestore with cascade cleanup
  - **Teacher deletion**: Removes all courses, materials, and Q&A owned by teacher
  - **Student deletion**: Removes all enrollments and questions posted by student
  - **Admin protection**: Returns 403 if attempting to delete admin users
- `POST /admin/create-admin` - Create another admin account

### Middleware Guards
- `isAuthenticated` - Verifies Firebase ID token, attaches `req.user`
- `isAdmin` - Checks if user role is "admin"
- `isTeacher` - Checks if user role is "teacher" AND status is "active"
- `isPaidTier` - Checks if user tier is "paid"

### Data Models

#### UserData (Firestore: `users/{uid}`)
```typescript
{
  uid: string;
  email: string;
  name?: string;
  role: "student" | "teacher" | "admin";
  tier: "free" | "paid";
  status: "active" | "pending" | "rejected";
  createdAt: string;
}
```

#### CourseData (Firestore: `courses/{courseId}`)
```typescript
{
  teacherId: string;
  title: string;
  description: string;
  category: "grammar" | "conversation";
  isPaid: boolean;
  status: "draft" | "published";
  createdAt: string;
  updatedAt: string;
}
```

#### MaterialData (Firestore: `courses/{courseId}/materials/{materialId}`)
```typescript
{
  title: string;
  type: "video" | "youtube" | "quiz" | "pdf";
  url: string;           // For quizzes: stringified JSON array of QuizQuestion[]
  isFreePreview: boolean;
  order: number;
}
```

#### QuizQuestion (stored as JSON string in `MaterialData.url` when `type === 'quiz'`)
```typescript
{
  id: number;
  type: "mcq" | "true_false" | "fill_blank";
  question: string;
  options?: string[];       // MCQ: 4 options, True/False: ["True", "False"], Fill: absent
  correctAnswer: string;   // Must match one of options for MCQ/True-False
  explanation?: string;
}
```

#### QuestionData (Firestore: `courses/{courseId}/questions/{questionId}`)
```typescript
{
  courseId: string;
  userId: string;
  userName: string;
  content: string;
  createdAt: string;
  isAnswered: boolean;
  answerText?: string;
  answeredAt?: string;
}
```

#### EnrollmentData (Firestore: `enrollments/{enrollmentId}`)
```typescript
{
  userId: string;
  courseId: string;
  enrolledAt: string;
  progress: number;        // 0-100
  completedAt?: string;   // Set when progress reaches 100
  totalHours: number;
  lastAccessedAt?: string;
}
```

### Testing
- **Framework**: Jest + ts-jest + supertest
- **Config**: `jest.config.js` in functions directory
- **Commands**:
  - `npm test` - Run all tests
  - `npm run test:watch` - Watch mode
  - `npm run test:coverage` - Coverage report
- **Mock Firestore** for unit tests using `jest.mock()`
- **Test Files**:
  - `functions/test/admin.model.test.ts` - Admin logic (User management, Teacher approvals, Cascade delete)
  - `functions/test/question.model.test.ts` - Q&A logic

### Build & Deploy
- `npm run build` - TypeScript compilation (must pass before deploy)
- `npm run deploy` - Deploy to Firebase Cloud Functions
- Entry point: `functions/lib/index.js` (compiled from src/index.ts)
- **`skipLibCheck: true`** is set in `tsconfig.json` for `@google/genai` compatibility

## AI Quiz Generation Feature

### Architecture
- **Backend Service**: `functions/src/services/gemini.service.ts`
  - Uses `@google/genai` SDK (`GoogleGenAI` class)
  - Model: `gemini-2.5-flash` (Note: 2.0-flash is deprecated and unsupported)
  - Prompts Gemini with combined PDF text + parameters, returns structured JSON array
- **Backend Controller**: `functions/src/controllers/quiz.controller.ts`
  - Fetches each PDF URL via `fetch()`, extracts text using `pdf-parse` v2 syntax (`new PDFParse({ data: buffer }).getText()`)
  - Calls `generateQuizFromAI()`, saves result via `addMaterialToCourse()` as `type: 'quiz'`
  - Route: `POST /courses/:courseId/materials/generate-quiz`

### Quiz Parameters
```typescript
{
  title: string;                               // Quiz name saved as material title
  numberOfQuestions: number;                    // 1-40
  language: "english" | "french";
  questionTypes: ("mcq" | "true_false" | "fill_blank")[];
  difficulty: "easy" | "medium" | "hard";
  isFreePreview: boolean;
  pdfUrls: string[];                           // Firebase Storage download URLs
}
```

### Frontend Components
- **`AddMaterialModal.tsx`** (`teacherPages/components/`)
  - Type selector: Video Upload / PDF File / **AI Quiz**
  - Quiz tab: Displays a dropdown to select *existing* PDFs from the course library, question count slider (1-40), language picker (üá´üá∑/üá¨üáß), question type checkboxes, difficulty buttons.
  - Generates the quiz via API; on success, the quiz is saved directly to the database.
- **`AddLessonModal.tsx`** (`teacherPages/components/`)
  - Teachers can select an *existing* Auto-Generated Quiz to attach to a specific lesson, exactly like legacy PDFs.
  - The lesson's `quiz` field in Firestore is populated with `{ id, title, url }` containing the quiz stringified JSON.
- **`QuizPlayer.tsx`** (`components/`)
  - Renders questions one-by-one with a progress bar header
  - MCQ / True-False: clickable option buttons (highlighted green/red post-submit)
  - Fill-in-the-Blank: text input with correct answer shown on submit
  - Navigation dots, Previous/Next/Submit Quiz/View Results buttons
  - Results screen: score %, question-by-question review, Retry button
- **`CoursePlayer.tsx`** (`pages/`)
  - Lesson-specific quizzes show a **"Start Quiz"** button (purple) right below the lesson PDF.
  - Global Course materials show a **"Take Quiz"** button (purple).
  - Clicking them parses `material.url` JSON and renders `<QuizPlayer />` inline over the video area.

### Timeout Configuration
- When using the Gemini API and Firebase HTTP Functions, requests can take 15-40 seconds. Ensure **Axios timeouts are disabled/removed** in `api/index.ts` so requests don't abort at 10000ms.

### Required Environment Variable
```
GEMINI_API_KEY=<your-api-key>
```
Must be set in Firebase Functions environment (`functions/.env` for emulator, Firebase Config for production).


## Deployment & Configuration

### Environment Setup
- **Development**: Uses `.env` with `VITE_USE_EMULATOR=true` to connect to local Firebase Emulators.
- **Production**: Uses `.env.production` with `VITE_USE_EMULATOR=false` ensuring the app connects to live Firebase services.
- **IMPORTANT**: Always ensure `.env.production` exists before building for deployment to prevent the app from trying to connect to localhost in production.

### Backend Runtime
- **Node.js Version**: The project is configured to use `node: "24"` in `functions/package.json`.
  - *Note*: Ensure your deployment environment supports this version. If deployment fails, check compatibility.

### Firebase Integration (Critical)

#### Required Firestore Indexes
The application relies on specific composite indexes for complex queries. The `firestore.indexes.json` MUST contain:

1. **Courses Index** (For Teacher Dashboard):
```json
{
  "collectionGroup": "courses",
  "queryScope": "COLLECTION",
  "fields": [
    { "fieldPath": "teacherId", "order": "ASCENDING" },
    { "fieldPath": "createdAt", "order": "DESCENDING" }
  ]
}
```

2. **Questions Index** (For Teacher Q&A):
```json
{
  "collectionGroup": "questions",
  "queryScope": "COLLECTION_GROUP",
  "fields": [
    { "fieldPath": "isAnswered", "order": "ASCENDING" },
    { "fieldPath": "createdAt", "order": "DESCENDING" }
  ]
}
```

3. **Student Questions Index** (For Student My Questions Page):
```json
{
  "collectionGroup": "questions",
  "queryScope": "COLLECTION_GROUP",
  "fields": [
    { "fieldPath": "userId", "order": "ASCENDING" },
    { "fieldPath": "createdAt", "order": "DESCENDING" }
  ]
}
```

#### Storage Security
- **Rules**: `storage.rules` MUST allow:
  - **Read**: Public read access for authenticated users (`allow read: if request.auth != null;`).
  - **Write**: Owner-only write access to `materials/{userId}/{allPaths=**}`.

## Do NOT
- ‚ùå Use `window.location.href` for navigation
- ‚ùå Import React in every file (not needed in React 18)
- ‚ùå Use inline styles instead of Tailwind classes
- ‚ùå Hardcode colors - use Tailwind utilities
- ‚ùå Skip error boundaries for new features
- ‚ùå Forget default exports for lazy-loaded components
- ‚ùå Use external image CDNs (e.g., pravatar.cc) - use local/gradient
- ‚ùå Make direct database calls in controllers - always use model layer
- ‚ùå Use localStorage for authentication - use AuthContext

## Key Files Reference
- **API layer**: `src/api/` (index.ts, auth.api.ts, student.api.ts, admin.api.ts)
- **Configuration**: `src/config/firebase.ts`, `.env`
- **Contexts**: `src/contexts/AuthContext.tsx`
- **Component library**: `src/components/`
- **Route components**: `src/pages/`, `src/forms/`, `src/teacherPages/`, `src/adminPages/`
- **Type definitions**: `src/types/course.ts`, `src/types/user.ts`, `src/types/admin.ts`
- **Styling config**: `src/index.css` (Tailwind v4)
- **Main app**: `src/App.tsx` (with lazy loading + ErrorBoundary + AuthProvider)

